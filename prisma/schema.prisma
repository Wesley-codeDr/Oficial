// WellWave MVP - Prisma Schema
// Based on: /specs/1-wellwave-mvp/data-model.md

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER MODEL
// ============================================
// Represents a registered physician in the system
// Linked to Supabase Auth via id
model User {
  id          String    @id @default(uuid())
  email       String    @unique
  fullName    String    @map("full_name")
  crmNumber   String    @map("crm_number")
  crmState    String    @map("crm_state") @db.Char(2)
  specialty   String?
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  lastLoginAt DateTime? @map("last_login_at")

  // Relations
  sessions                 AnamneseSession[]
  conversations            ChatConversation[]
  auditLogs                AuditLog[]
  chiefComplaintSessions   ChiefComplaintSession[]

  @@index([email])
  @@index([crmNumber, crmState])
  @@map("users")
}

// ============================================
// SYNDROME MODEL
// ============================================
// Clinical syndrome template with associated checkboxes
model Syndrome {
  id          String   @id @default(uuid())
  name        String   @unique
  code        String   @unique
  description String?
  icon        String?
  orderIndex  Int      @map("order_index")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  checkboxes      Checkbox[]
  redFlagRules    RedFlagRule[]
  sessions        AnamneseSession[]
  chiefComplaints ChiefComplaint[]

  @@index([code])
  @@index([orderIndex])
  @@map("syndromes")
}

// ============================================
// CHECKBOX MODEL
// ============================================
// Individual checkbox item associated with a syndrome
model Checkbox {
  id            String           @id @default(uuid())
  syndromeId    String           @map("syndrome_id")
  category      CheckboxCategory
  displayText   String           @map("display_text")
  narrativeText String           @map("narrative_text")
  isRequired    Boolean          @default(false) @map("is_required")
  isRedFlag     Boolean          @default(false) @map("is_red_flag")
  isNegative    Boolean          @default(false) @map("is_negative")
  orderIndex    Int              @map("order_index")
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")

  // Relations
  syndrome Syndrome @relation(fields: [syndromeId], references: [id], onDelete: Cascade)

  @@index([syndromeId])
  @@index([category])
  @@index([orderIndex])
  @@map("checkboxes")
}

enum CheckboxCategory {
  QP           // Queixa Principal
  HDA          // Historia da Doenca Atual
  ANTECEDENTES // Antecedentes Pessoais
  MEDICACOES   // Medicacoes em Uso
  ALERGIAS     // Alergias
  HABITOS      // Habitos
  EXAME_FISICO // Exame Fisico
  NEGATIVAS    // Negativas Importantes

  @@map("checkbox_category")
}

// ============================================
// RED FLAG RULE MODEL
// ============================================
// Rules for automatic detection of alarm signs
model RedFlagRule {
  id            String          @id @default(uuid())
  syndromeId    String          @map("syndrome_id")
  name          String
  description   String?
  severity      RedFlagSeverity
  conditionJson Json            @map("condition_json")
  message       String
  isActive      Boolean         @default(true) @map("is_active")
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  // Relations
  syndrome Syndrome @relation(fields: [syndromeId], references: [id], onDelete: Cascade)

  @@index([syndromeId])
  @@map("red_flag_rules")
}

enum RedFlagSeverity {
  WARNING
  CRITICAL

  @@map("red_flag_severity")
}

// ============================================
// ANAMNESE SESSION MODEL
// ============================================
// Anamnesis filling session
model AnamneseSession {
  id               String     @id @default(uuid())
  userId           String     @map("user_id")
  syndromeId       String     @map("syndrome_id")
  checkedItems     Json       @map("checked_items") // Array of checkbox IDs
  generatedText    String?    @map("generated_text") @db.Text
  outputMode       OutputMode @default(SUMMARY) @map("output_mode")
  redFlagsDetected Json?      @map("red_flags_detected") // Array of RedFlagRule IDs
  wasCopied        Boolean    @default(false) @map("was_copied")
  startedAt        DateTime   @default(now()) @map("started_at")
  completedAt      DateTime?  @map("completed_at")
  createdAt        DateTime   @default(now()) @map("created_at")

  // Relations
  user         User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  syndrome     Syndrome          @relation(fields: [syndromeId], references: [id])
  conversation ChatConversation?

  @@index([userId])
  @@index([syndromeId])
  @@index([startedAt])
  @@map("anamnese_sessions")
}

enum OutputMode {
  SUMMARY  // Modo resumido (PS)
  DETAILED // Modo expandido (internacao)

  @@map("output_mode")
}

// ============================================
// CHAT CONVERSATION MODEL
// ============================================
// Conversation with EBM Chat associated with a session
model ChatConversation {
  id              String   @id @default(uuid())
  sessionId       String?  @unique @map("session_id")
  userId          String   @map("user_id")
  contextSnapshot Json?    @map("context_snapshot") // Snapshot of anamnese at conversation start
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  session  AnamneseSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages ChatMessage[]

  @@index([userId])
  @@index([sessionId])
  @@map("chat_conversations")
}

// ============================================
// CHAT MESSAGE MODEL
// ============================================
// Individual message in a chat conversation
model ChatMessage {
  id             String      @id @default(uuid())
  conversationId String      @map("conversation_id")
  role           MessageRole
  content        String      @db.Text
  citations      Json?       // Array of citation objects
  createdAt      DateTime    @default(now()) @map("created_at")

  // Relations
  conversation ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@map("chat_messages")
}

enum MessageRole {
  USER
  ASSISTANT

  @@map("message_role")
}

// ============================================
// AUDIT LOG MODEL
// ============================================
// Audit log for compliance
model AuditLog {
  id           String   @id @default(uuid())
  userId       String?  @map("user_id")
  action       String
  resourceType String   @map("resource_type")
  resourceId   String?  @map("resource_id")
  metadata     Json?
  ipAddress    String?  @map("ip_address")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([resourceType])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// RATE LIMIT ENTRY MODEL
// ============================================
// Distributed rate limiting entries for chat messages
model RateLimitEntry {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  timestamp DateTime @default(now())

  @@index([userId, timestamp])
  @@index([timestamp])
  @@map("rate_limit_entries")
}

// ============================================
// CHIEF COMPLAINT GROUP MODEL
// ============================================
// Macro groups for chief complaints (18 categories)
// CV, RC, NC, GI, GU, MSK, INF, MET, DERM, OFT, ORL, OBG, PED, PSI, TOX, TR, ENV, GEN
model ChiefComplaintGroup {
  id          String   @id @default(uuid())
  code        String   @unique
  namePt      String   @map("name_pt")
  nameEn      String   @map("name_en")
  description String?
  icon        String?
  color       String?
  orderIndex  Int      @map("order_index")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  complaints ChiefComplaint[]

  @@index([code])
  @@index([orderIndex])
  @@map("chief_complaint_groups")
}

// ============================================
// CHIEF COMPLAINT MODEL
// ============================================
// Individual chief complaints (150+)
model ChiefComplaint {
  id                  String   @id @default(uuid())
  groupId             String   @map("group_id")
  code                String   @unique
  namePt              String   @map("name_pt")
  nameEn              String?  @map("name_en")
  definition          String?  @db.Text
  synonyms            String[]
  icd10Codes          String[] @map("icd10_codes")
  isTimeSensitive     Boolean  @default(false) @map("is_time_sensitive")
  isHighAcuity        Boolean  @default(false) @map("is_high_acuity")
  requiresIsolation   Boolean  @default(false) @map("requires_isolation")
  syndromeId          String?  @map("syndrome_id")
  defaultCalculatorId String?  @map("default_calculator_id")
  clinicalFlow        Json?    @map("clinical_flow")
  additionalData      Json?    @map("additional_data")
  orderIndex          Int      @map("order_index")
  isActive            Boolean  @default(true) @map("is_active")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  group    ChiefComplaintGroup     @relation(fields: [groupId], references: [id])
  syndrome Syndrome?               @relation(fields: [syndromeId], references: [id])
  tags     ChiefComplaintTag[]
  sessions ChiefComplaintSession[]

  @@index([groupId])
  @@index([code])
  @@index([syndromeId])
  @@index([isTimeSensitive])
  @@index([isHighAcuity])
  @@index([orderIndex])
  @@map("chief_complaints")
}

// ============================================
// CHIEF COMPLAINT TAG MODEL
// ============================================
// Multi-dimensional tagging system for complaints
model ChiefComplaintTag {
  id          String      @id @default(uuid())
  complaintId String      @map("complaint_id")
  category    TagCategory
  value       String
  createdAt   DateTime    @default(now()) @map("created_at")

  // Relations
  complaint ChiefComplaint @relation(fields: [complaintId], references: [id], onDelete: Cascade)

  @@unique([complaintId, category, value])
  @@index([complaintId])
  @@index([category])
  @@index([value])
  @@map("chief_complaint_tags")
}

enum TagCategory {
  AGE      // pediatric, adult, elderly, neonate, obstetric
  SYSTEM   // cardiovascular, respiratory, neurological, etc.
  SYNDROME // acute_coronary_syndrome, stroke, sepsis, etc.
  RISK     // high_acuity, time_sensitive, life_threatening
  CONTEXT  // post_surgical, oncological, immunocompromised

  @@map("tag_category")
}

// ============================================
// CHIEF COMPLAINT SESSION MODEL
// ============================================
// Sessions using the new ChiefComplaint system
model ChiefComplaintSession {
  id                String    @id @default(uuid())
  userId            String    @map("user_id")
  chiefComplaintId  String    @map("chief_complaint_id")
  patientContext    Json      @map("patient_context")
  selectedFlow      Json?     @map("selected_flow")
  calculatorResults Json?     @map("calculator_results")
  generatedText     String?   @map("generated_text") @db.Text
  redFlagsDetected  Json?     @map("red_flags_detected")
  startedAt         DateTime  @default(now()) @map("started_at")
  completedAt       DateTime? @map("completed_at")
  createdAt         DateTime  @default(now()) @map("created_at")

  // Relations
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  chiefComplaint ChiefComplaint @relation(fields: [chiefComplaintId], references: [id])

  @@index([userId])
  @@index([chiefComplaintId])
  @@index([startedAt])
  @@map("chief_complaint_sessions")
}
