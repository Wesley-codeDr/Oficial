name: Spec-Kit Validation

on:
  pull_request:
    paths:
      - 'specs/**'
      - 'docs/**'
      - 'templates/**'
      - 'scripts/validate-specs.sh'
      - '.github/workflows/spec-validation.yml'
  push:
    branches:
      - main
      - develop
    paths:
      - 'specs/**'
      - 'docs/**'
  workflow_dispatch:

jobs:
  validate-spec-kit-compliance:
    runs-on: ubuntu-latest
    name: Validate Spec-Kit Compliance

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Make validation script executable
        run: chmod +x scripts/validate-specs.sh

      - name: Validate Spec Structure
        run: |
          echo "Validating Spec-Kit structure..."
          ./scripts/validate-specs.sh --all || exit 1

      - name: Check Required Files
        run: |
          echo "Checking required Spec-Kit files..."
          
          # Check constitution exists
          if [ ! -f "memory/constitution.md" ]; then
            echo "âŒ Error: memory/constitution.md is missing"
            exit 1
          fi
          
          # Check templates exist
          REQUIRED_TEMPLATES=(
            "templates/spec-template.md"
            "templates/plan-template.md"
            "templates/tasks-template.md"
          )
          
          for template in "${REQUIRED_TEMPLATES[@]}"; do
            if [ ! -f "$template" ]; then
              echo "âŒ Error: Required template missing: $template"
              exit 1
            fi
          done
          
          echo "âœ… All required files present"

      - name: Validate Spec Naming Convention
        run: |
          echo "Validating spec naming convention..."
          
          # Check that specs follow XXX-feature-name format
          for spec_dir in specs/*/; do
            if [ -d "$spec_dir" ]; then
              spec_name=$(basename "$spec_dir")
              if [[ ! "$spec_name" =~ ^[0-9]{3}-[a-z0-9-]+$ ]]; then
                echo "âŒ Error: Spec '$spec_name' does not follow naming convention (XXX-feature-name)"
                exit 1
              fi
            fi
          done
          
          echo "âœ… All specs follow naming convention"

      - name: Check Spec Completeness
        run: |
          echo "Checking spec completeness..."
          
          for spec_dir in specs/*/; do
            if [ -d "$spec_dir" ]; then
              spec_name=$(basename "$spec_dir")
              
              # Skip archived and templates
              if [[ "$spec_name" == "archived" ]] || [[ "$spec_name" == "templates" ]]; then
                continue
              fi
              
              # Check required files
              if [ ! -f "$spec_dir/spec.md" ]; then
                echo "âš ï¸  Warning: $spec_name/spec.md is missing"
              fi
              
              if [ ! -f "$spec_dir/plan.md" ]; then
                echo "âš ï¸  Warning: $spec_name/plan.md is missing"
              fi
              
              if [ ! -f "$spec_dir/tasks.md" ]; then
                echo "âš ï¸  Warning: $spec_name/tasks.md is missing"
              fi
            fi
          done
          
          echo "âœ… Spec completeness check completed"

      - name: Validate Template Compliance
        run: |
          echo "Validating template compliance..."
          
          # Check that templates contain Spec-Kit references
          for template in templates/*.md; do
            if [ -f "$template" ]; then
              if ! grep -q "Spec-Kit" "$template" && ! grep -q "spec-kit" "$template"; then
                echo "âš ï¸  Warning: Template $(basename $template) may not reference Spec-Kit"
              fi
            fi
          done
          
          echo "âœ… Template compliance check completed"

      - name: Summary
        run: |
          echo "## Spec-Kit Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Spec structure validated" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Required files checked" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Naming convention validated" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Spec completeness checked" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Template compliance validated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** All Spec-Kit compliance checks passed! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
